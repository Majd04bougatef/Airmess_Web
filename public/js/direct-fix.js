/**
 * SOLUTION DIRECTE ET FINALE POUR L'AFFICHAGE DES NOTES
 * Ce script est une solution autonome qui fonctionne indÃ©pendamment des autres
 */

(function() {
    console.log("=== SOLUTION DIRECTE POUR L'AFFICHAGE DES NOTES ===");

    // ExÃ©cuter immÃ©diatement aprÃ¨s chargement de la page
    window.addEventListener('DOMContentLoaded', function() {
        init();
    });
    
    // RÃ©essayer aprÃ¨s le chargement complet en cas d'Ã©chec
    window.addEventListener('load', function() {
        setTimeout(function() {
            checkAndRepair();
        }, 500);
    });
    
    function init() {
        console.log("Initialisation de la solution directe");
        
        // 1. Ajouter un bouton pour activer la solution manuellement
        addRepairButton();
        
        // 2. Enregistrer un gestionnaire pour le formulaire d'ajout
        setupFormHandler();
        
        // 3. VÃ©rifier s'il y a des Ã©vÃ©nements Ã  afficher
        checkAndRepair();
    }
    
    function addRepairButton() {
        // Chercher le conteneur du calendrier
        let container = document.querySelector('.calendar-container');
        if (!container) {
            // Fallback: chercher dans le document
            container = document.getElementById('calendarMainContainer');
            if (!container) {
                console.error("Impossible de trouver le conteneur du calendrier");
                return;
            }
        }
        
        // CrÃ©er le bouton d'urgence
        const fixButton = document.createElement('button');
        fixButton.id = 'directFixBtn';
        fixButton.className = 'btn btn-danger w-100 mb-3';
        fixButton.innerHTML = 'ðŸ”§ SOLUTION ULTIME - AFFICHER MES NOTES';
        fixButton.onclick = function() {
            forceFixCalendar(true);
        };
        
        // Ajouter en haut
        const existingButton = document.getElementById('directFixBtn');
        if (!existingButton) {
            container.insertBefore(fixButton, container.firstChild);
        }
    }
    
    function setupFormHandler() {
        // Intercepter le formulaire d'ajout de notes
        const eventForm = document.getElementById('eventForm');
        if (!eventForm) {
            console.warn("Formulaire d'ajout de notes non trouvÃ©");
            return;
        }
        
        // Sauvegarder le gestionnaire d'Ã©vÃ©nements d'origine
        const originalHandler = eventForm.onsubmit;
        
        // Ajouter notre gestionnaire
        eventForm.addEventListener('submit', function(e) {
            console.log("Formulaire soumis, capture de l'Ã©vÃ©nement");
            
            // Ne pas empÃªcher le traitement normal si notre code Ã©choue
            try {
                // RÃ©cupÃ©rer les valeurs du formulaire
                const title = document.getElementById('eventTitle').value;
                const date = document.getElementById('eventDate').value;
                const description = document.getElementById('eventDescription').value || '';
                const color = document.getElementById('eventColor').value || '#5e72e4';
                
                // Valider les donnÃ©es
                if (!title || !date) {
                    return; // Laisser la validation normale du formulaire s'exÃ©cuter
                }
                
                // CrÃ©er un nouvel Ã©vÃ©nement
                const newEvent = {
                    id: Date.now().toString(),
                    title: title,
                    date: date,
                    description: description,
                    color: color
                };
                
                // RÃ©cupÃ©rer les Ã©vÃ©nements existants
                let events = [];
                try {
                    events = JSON.parse(localStorage.getItem('bonplan_calendar_events') || '[]');
                } catch (err) {
                    console.error("Erreur de lecture des Ã©vÃ©nements:", err);
                    events = [];
                }
                
                // Ajouter le nouvel Ã©vÃ©nement
                events.push(newEvent);
                
                // Sauvegarder les Ã©vÃ©nements
                localStorage.setItem('bonplan_calendar_events', JSON.stringify(events));
                console.log("Ã‰vÃ©nement ajoutÃ© au stockage:", newEvent);
                
                // Planifier un rafraÃ®chissement automatique
                setTimeout(function() {
                    forceFixCalendar(false);
                }, 300);
            } catch (err) {
                console.error("Erreur lors de la capture du formulaire:", err);
            }
        });
    }
    
    function checkAndRepair() {
        try {
            // VÃ©rifier s'il y a des Ã©vÃ©nements dans le stockage
            const events = JSON.parse(localStorage.getItem('bonplan_calendar_events') || '[]');
            
            // VÃ©rifier s'il y a des Ã©vÃ©nements affichÃ©s
            const displayed = document.querySelectorAll('.calendar-event');
            
            console.log(`VÃ©rification: ${events.length} Ã©vÃ©nements dans le stockage, ${displayed.length} affichÃ©s`);
            
            // Si nous avons des Ã©vÃ©nements non affichÃ©s, exÃ©cuter la rÃ©paration
            if (events.length > 0 && displayed.length === 0) {
                console.log("Ã‰vÃ©nements non affichÃ©s dÃ©tectÃ©s, exÃ©cution de la rÃ©paration automatique");
                forceFixCalendar(false);
            }
        } catch (err) {
            console.error("Erreur lors de la vÃ©rification:", err);
        }
    }
    
    function forceFixCalendar(interactive) {
        console.log("ExÃ©cution de la rÃ©paration forcÃ©e");
        
        try {
            // 1. RÃ©cupÃ©rer tous les Ã©vÃ©nements
            const events = JSON.parse(localStorage.getItem('bonplan_calendar_events') || '[]');
            
            if (events.length === 0) {
                if (interactive) {
                    alert("Aucune note Ã  afficher. Ajoutez d'abord une note dans le formulaire.");
                }
                return;
            }
            
            // 2. VÃ©rifier si nous devons naviguer vers un autre mois
            checkAndNavigateToEventMonth(events, interactive);
            
            // 3. Forcer l'affichage des Ã©vÃ©nements
            displayEvents(events);
            
            // 4. Afficher un message de confirmation
            if (interactive) {
                alert(`Solution appliquÃ©e avec succÃ¨s. ${events.length} notes sont maintenant disponibles.`);
            }
        } catch (err) {
            console.error("Erreur lors de la rÃ©paration forcÃ©e:", err);
            if (interactive) {
                alert("Une erreur s'est produite lors de la rÃ©paration. Voir la console pour plus de dÃ©tails.");
            }
        }
    }
    
    function checkAndNavigateToEventMonth(events, interactive) {
        if (!events.length) return;
        
        try {
            // DÃ©terminer le mois courant affichÃ©
            const currentMonthYear = {
                month: typeof window.currentMonth !== 'undefined' ? window.currentMonth : new Date().getMonth(),
                year: typeof window.currentYear !== 'undefined' ? window.currentYear : new Date().getFullYear()
            };
            
            // Compter les Ã©vÃ©nements par mois
            const monthCounts = {};
            events.forEach(event => {
                if (!event.date) return;
                
                const parts = event.date.split('-');
                if (parts.length !== 3) return;
                
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Convertir en index de mois (0-11)
                
                const key = `${year}-${month}`;
                if (!monthCounts[key]) {
                    monthCounts[key] = 0;
                }
                monthCounts[key]++;
            });
            
            // Trouver le mois avec le plus d'Ã©vÃ©nements
            let maxCount = 0;
            let targetMonthYear = null;
            
            Object.keys(monthCounts).forEach(key => {
                if (monthCounts[key] > maxCount) {
                    maxCount = monthCounts[key];
                    targetMonthYear = key;
                }
            });
            
            if (targetMonthYear) {
                const [targetYear, targetMonth] = targetMonthYear.split('-').map(Number);
                
                // VÃ©rifier si nous devons naviguer
                if (targetMonth !== currentMonthYear.month || targetYear !== currentMonthYear.year) {
                    if (interactive) {
                        const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                           'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
                        
                        if (confirm(`La plupart de vos notes (${maxCount}) sont en ${monthNames[targetMonth]} ${targetYear}. Voulez-vous naviguer vers ce mois?`)) {
                            navigateToMonth(targetMonth, targetYear);
                        }
                    } else {
                        // En mode automatique, naviguer si plus de 80% des Ã©vÃ©nements sont dans ce mois
                        const totalEvents = events.length;
                        if (maxCount > totalEvents * 0.8) {
                            navigateToMonth(targetMonth, targetYear);
                        }
                    }
                }
            }
        } catch (err) {
            console.error("Erreur lors de la navigation:", err);
        }
    }
    
    function navigateToMonth(month, year) {
        console.log(`Navigation vers ${month+1}/${year}`);
        
        try {
            // Mettre Ã  jour les variables globales
            if (typeof window.currentMonth !== 'undefined') {
                window.currentMonth = month;
            }
            if (typeof window.currentYear !== 'undefined') {
                window.currentYear = year;
            }
            
            // Essayer d'appeler la fonction de gÃ©nÃ©ration du calendrier
            if (typeof window.generateCalendar === 'function') {
                window.generateCalendar();
                console.log("Calendrier rÃ©gÃ©nÃ©rÃ© avec succÃ¨s");
            } else {
                // Fallback: essayer de cliquer sur les boutons de navigation
                const diff = (year * 12 + month) - (new Date().getFullYear() * 12 + new Date().getMonth());
                
                if (diff === 0) {
                    // Mois actuel
                    const currentBtn = document.getElementById('currentMonth');
                    if (currentBtn) currentBtn.click();
                } else if (diff < 0) {
                    // Mois prÃ©cÃ©dent(s)
                    const prevBtn = document.getElementById('prevMonth');
                    if (prevBtn) {
                        for (let i = 0; i > diff; i--) {
                            prevBtn.click();
                        }
                    }
                } else {
                    // Mois suivant(s)
                    const nextBtn = document.getElementById('nextMonth');
                    if (nextBtn) {
                        for (let i = 0; i < diff; i++) {
                            nextBtn.click();
                        }
                    }
                }
            }
        } catch (err) {
            console.error("Erreur lors de la navigation:", err);
        }
    }
    
    function displayEvents(events) {
        if (!events.length) return;
        
        console.log("Affichage forcÃ© des Ã©vÃ©nements");
        
        try {
            // 1. Supprimer tous les Ã©vÃ©nements existants
            document.querySelectorAll('.calendar-event').forEach(el => el.remove());
            
            // 2. Pour chaque Ã©vÃ©nement, trouver le conteneur correspondant et afficher
            let displayed = 0;
            let missing = 0;
            
            events.forEach(event => {
                if (!event.date) return;
                
                // Trouver le conteneur pour cette date
                const container = document.querySelector(`.calendar-events[data-date="${event.date}"]`);
                
                if (container) {
                    // CrÃ©er l'Ã©lÃ©ment d'Ã©vÃ©nement
                    const eventEl = document.createElement('div');
                    eventEl.className = 'calendar-event';
                    eventEl.textContent = event.title;
                    eventEl.dataset.eventId = event.id;
                    eventEl.style.backgroundColor = event.color || '#5e72e4';
                    
                    // Ajouter l'Ã©vÃ©nement au conteneur
                    container.appendChild(eventEl);
                    displayed++;
                    
                    // Ajouter un gestionnaire de clic
                    eventEl.addEventListener('click', function(e) {
                        e.stopPropagation();
                        alert(`Note: ${event.title}\nDate: ${event.date}\nDescription: ${event.description || '(Aucune description)'}`);
                    });
                } else {
                    missing++;
                }
            });
            
            console.log(`Ã‰vÃ©nements affichÃ©s: ${displayed}/${events.length} (${missing} non affichables dans le mois actuel)`);
        } catch (err) {
            console.error("Erreur lors de l'affichage des Ã©vÃ©nements:", err);
        }
    }
})(); 