{% extends 'dashAdmin/dashboard.html.twig' %}

{% block title %}Gestion des Utilisateurs{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
  /* Main Container & Elements */
  .container-fluid {
    padding: 2rem;
  }
  
  /* Modern Card Styling */
  .card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.07);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    background: #fff;
    margin-bottom: 1.5rem;
  }
  
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
  }
  
  .card-header {
    background: linear-gradient(to right, #f8f9fa, #ffffff);
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 1.25rem 1.5rem;
  }
  
  /* Filter Controls */
  .filter-section {
    padding: 1.25rem;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 3px 10px rgba(0,0,0,0.03);
  }
  
  /* Button Styling */
  .btn {
    font-weight: 600;
    letter-spacing: 0.3px;
    padding: 0.55rem 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.04);
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.07);
  }
  
  .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.82rem;
  }
  
  /* Filter Toggle Buttons */
  .btn-check:checked + .btn-outline-secondary,
  .btn-check:checked + .btn-outline-primary,
  .btn-check:checked + .btn-outline-info,
  .btn-check:checked + .btn-outline-success,
  .btn-check:checked + .btn-outline-danger {
    color: #fff;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  
  .btn-check:checked + .btn-outline-secondary {
    background: linear-gradient(45deg, #6c757d, #5a6268);
    border-color: #5a6268;
  }
  
  .btn-check:checked + .btn-outline-primary {
    background: linear-gradient(45deg, #4e73df, #3a54c4);
    border-color: #3a54c4;
  }
  
  .btn-check:checked + .btn-outline-info {
    background: linear-gradient(45deg, #36b9cc, #258391);
    border-color: #258391;
  }
  
  .btn-check:checked + .btn-outline-success {
    background: linear-gradient(45deg, #1cc88a, #13855c);
    border-color: #13855c;
  }
  
  .btn-check:checked + .btn-outline-danger {
    background: linear-gradient(45deg, #e74a3b, #be2e1f);
    border-color: #be2e1f;
  }
  
  /* Table Styling */
  .table {
    margin-bottom: 0;
    border-collapse: separate;
    border-spacing: 0;
  }
  
  .table thead th {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.7px;
    padding: 1rem;
    background: linear-gradient(to right, #f8f9fa, #ffffff);
    border-bottom: 2px solid #f0f2f5;
    color: #4e73df;
  }
  
  .table tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid #f3f3f3;
  }
  
  .table tbody tr:hover {
    background-color: rgba(78, 115, 223, 0.04);
    transform: translateX(3px);
  }
  
  .table td {
    padding: 1rem;
    vertical-align: middle;
  }
  
  /* Badges & Status Indicators */
  .badge {
    padding: 0.5em 0.85em;
    font-weight: 600;
    letter-spacing: 0.3px;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
  }
  
  .badge:hover {
    transform: scale(1.05);
  }
  
  .bg-primary {
    background: linear-gradient(45deg, #4e73df, #3a54c4) !important;
  }
  
  .bg-success {
    background: linear-gradient(45deg, #1cc88a, #13855c) !important;
  }
  
  .bg-info {
    background: linear-gradient(45deg, #36b9cc, #258391) !important;
  }
  
  .bg-warning {
    background: linear-gradient(45deg, #f6c23e, #dda20a) !important;
  }
  
  .bg-danger {
    background: linear-gradient(45deg, #e74a3b, #be2e1f) !important;
  }
  
  /* User Avatar & Info */
  .avatar {
    width: 45px;
    height: 45px;
    object-fit: cover;
    border: 3px solid #fff;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }
  
  .avatar:hover {
    transform: scale(1.1);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
  }
  
  .avatar-container {
    position: relative;
    margin-right: 1rem;
  }
  
  .rounded-circle {
    border-radius: 50% !important;
  }
  
  .user-name {
    color: #333;
    font-weight: 600;
    margin-bottom: 0.25rem;
    transition: color 0.2s ease;
  }
  
  .user-info-cell:hover .user-name {
    color: #4e73df;
  }
  
  /* Online Status Indicator */
  .online-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
    position: absolute;
    right: 0;
    bottom: 0;
    border: 2px solid #fff;
  }
  
  .online-yes {
    background-color: #1cc88a;
    box-shadow: 0 0 10px rgba(28, 200, 138, 0.5);
    animation: pulse 2s infinite;
  }
  
  .online-no {
    background-color: #adb5bd;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(28, 200, 138, 0.5); }
    70% { box-shadow: 0 0 0 6px rgba(28, 200, 138, 0); }
    100% { box-shadow: 0 0 0 0 rgba(28, 200, 138, 0); }
  }
  
  /* Pagination Styling */
  .pagination {
    gap: 0.3rem;
  }
  
  .page-item.active .page-link {
    background: linear-gradient(45deg, #4e73df, #3a54c4);
    border-color: #3a54c4;
    box-shadow: 0 3px 8px rgba(78, 115, 223, 0.3);
  }
  
  .page-link {
    color: #4e73df;
    border-radius: 6px;
    padding: 0.5rem 0.8rem;
    font-weight: 600;
    border: none;
    transition: all 0.2s ease;
  }
  
  .page-link:hover {
    background-color: #eaecf4;
    transform: translateY(-2px);
  }
  
  /* Search Box Styling */
  .input-group {
    box-shadow: 0 3px 10px rgba(0,0,0,0.03);
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .input-group:focus-within {
    box-shadow: 0 5px 15px rgba(78, 115, 223, 0.15);
  }
  
  .input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #eaecf4;
    border-right: none;
    color: #6e707e;
  }
  
  .form-control {
    border: 1px solid #eaecf4;
    border-left: none;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  
  .form-control:focus {
    box-shadow: none;
    border-color: #4e73df;
  }
  
  /* Modal Styling */
  .modal-content {
    border: none;
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    overflow: hidden;
  }
  
  .modal-header {
    background: linear-gradient(to right, #f8f9fa, #ffffff);
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 1.25rem 1.5rem;
  }
  
  .modal-footer {
    background: #f8f9fa;
    border-top: 1px solid rgba(0,0,0,0.05);
    padding: 1.25rem 1.5rem;
  }
  
  .form-label {
    font-weight: 600;
    color: #4e5055;
    margin-bottom: 0.5rem;
  }
  
  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .container-fluid {
      padding: 1rem;
    }
    
    .card-header {
      padding: 1rem;
    }
    
    .table td, .table th {
      padding: 0.75rem;
    }
    
    .avatar {
      width: 35px;
      height: 35px;
    }
  }
</style>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="{{ asset('js/user-filters.js') }}"></script>
<script>
  // Function to confirm deletion of a user
  window.confirmDelete = function(userId) {
    if (confirm("Êtes-vous sûr de vouloir désactiver cet utilisateur ?")) {
      const deletePath = `/admin/UserPage/delete/${userId}`;
      
      fetch(deletePath, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Utilisateur désactivé avec succès');
          window.location.reload();
        } else {
          alert('Erreur lors de la désactivation: ' + (data.message || 'Une erreur est survenue'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Une erreur est survenue lors de la désactivation');
      });
    }
  };

  // Function to submit the edit user form
  window.submitEditForm = function(userId) {
    const form = document.getElementById(`editUserForm${userId}`);
    
    if (!form) {
      console.error('Form not found:', `editUserForm${userId}`);
      alert('Erreur: Formulaire non trouvé');
      return;
    }
    
    // Check required fields
    const name = form.querySelector('[name="name"]');
    const prenom = form.querySelector('[name="prenom"]');
    const email = form.querySelector('[name="email"]');
    
    if (!name.value || !prenom.value || !email.value) {
      alert('Veuillez remplir tous les champs obligatoires');
      return;
    }
    
    // Create FormData from the form
    const formData = new FormData(form);
    
    // Debug form data
    console.log('Form data for user', userId);
    for (let pair of formData.entries()) {
      console.log(pair[0] + ': ' + pair[1]);
    }
    
    // Use fetch API to submit the form
    fetch(form.action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Server returned ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert('Utilisateur modifié avec succès');
        window.location.reload();
      } else {
        alert('Erreur: ' + (data.message || 'Une erreur est survenue'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Une erreur est survenue: ' + error.message);
    });
  };
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Breadcrumb & Search -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0">
          <li class="breadcrumb-item text-sm"><a class="opacity-5 text-white" href="{{ path('dashboard_page') }}">Dashboard</a></li>
          <li class="breadcrumb-item text-sm text-white active" aria-current="page">Gestion des Utilisateurs</li>
        </ol>
      </nav>
      <h2 class="font-weight-bolder text-white mb-0">Gestion des Utilisateurs</h2>
    </div>
    <div class="input-group" style="width: 300px;">
      <span class="input-group-text"><i class="fas fa-search"></i></span>
      <input type="text" id="searchInput" class="form-control" placeholder="Rechercher un utilisateur...">
    </div>
  </div>

  <!-- User Table Card -->
  <div class="card shadow mb-4">
    <div class="card-header d-flex justify-content-between align-items-center py-3">
      <div>
        <h6 class="mb-0 font-weight-bold">
          <i class="fas fa-users me-2"></i> Liste des utilisateurs
          <span class="badge bg-primary ms-2 user-counter">{{ users|length }}</span>
        </h6>
      </div>
      <div class="d-flex">
        <div class="input-group me-2" style="width: 250px;">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" id="tableSearchInput" class="form-control" placeholder="Rechercher...">
        </div>
        <button class="btn btn-sm btn-outline-success me-2" id="exportExcelButton">
          <i class="fas fa-file-excel me-1"></i> CSV
        </button>
        <button class="btn btn-sm btn-outline-danger" id="exportPdfButton">
          <i class="fas fa-file-pdf me-1"></i> PDF
        </button>
      </div>
    </div>
    
    <!-- Filter Controls -->
    <div class="card-header bg-light py-2">
      <div class="row g-2">
        <div class="col-md-6">
          <div class="filter-group">
            <label class="d-flex align-items-center mb-1">
              <i class="fas fa-filter me-1"></i> Filtrer par rôle:
            </label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="roleFilter" id="roleAll" value="" checked>
              <label class="btn btn-outline-secondary btn-sm" for="roleAll">
                <i class="fas fa-users me-1"></i> Tous
              </label>
              
              <input type="radio" class="btn-check" name="roleFilter" id="roleAdmin" value="Admin">
              <label class="btn btn-outline-primary btn-sm" for="roleAdmin">
                <i class="fas fa-user-shield me-1"></i> Admin
              </label>
              
              <input type="radio" class="btn-check" name="roleFilter" id="roleVoyageur" value="Voyageurs">
              <label class="btn btn-outline-info btn-sm" for="roleVoyageur">
                <i class="fas fa-plane me-1"></i> Voyageurs
              </label>
              
              <input type="radio" class="btn-check" name="roleFilter" id="roleEntreprise" value="Entreprise">
              <label class="btn btn-outline-success btn-sm" for="roleEntreprise">
                <i class="fas fa-building me-1"></i> Entreprise
              </label>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="filter-group">
            <label class="d-flex align-items-center mb-1">
              <i class="fas fa-toggle-on me-1"></i> Filtrer par statut:
            </label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="statusFilter" id="statusAll" value="" checked>
              <label class="btn btn-outline-secondary btn-sm" for="statusAll">
                <i class="fas fa-list me-1"></i> Tous
              </label>
              
              <input type="radio" class="btn-check" name="statusFilter" id="statusOnline" value="online">
              <label class="btn btn-outline-success btn-sm" for="statusOnline">
                <i class="fas fa-circle me-1"></i> En ligne
              </label>
              
              <input type="radio" class="btn-check" name="statusFilter" id="statusActive" value="actif">
              <label class="btn btn-outline-primary btn-sm" for="statusActive">
                <i class="fas fa-check-circle me-1"></i> Actifs
              </label>
              
              <input type="radio" class="btn-check" name="statusFilter" id="statusInactive" value="inactive">
              <label class="btn btn-outline-danger btn-sm" for="statusInactive">
                <i class="fas fa-times-circle me-1"></i> Inactifs
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <div class="text-end mt-2">
        <button id="resetFilters" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-sync-alt me-1"></i> Réinitialiser les filtres
        </button>
      </div>
    </div>
    
    <!-- Users Table -->
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table align-middle mb-0" id="usersTable" data-delete-path="/admin/user/delete/0">
          <thead class="bg-light">
            <tr>
              <th>Utilisateur</th>
              <th>Email</th>
              <th>Rôle</th>
              <th>Date de Naissance</th>
              <th>Statut</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            {% for user in users %}
            <tr data-role="{{ user.roleUser }}" data-status="{% if user.isOnline == 1 %}online{% elseif user.statut == 'actif' %}active{% else %}inactive{% endif %}">
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-container position-relative me-3">
                    {% if user.imagesU is not empty %}
                      <img src="{{ asset('images_users/' ~ user.imagesU) }}" alt="Avatar" class="avatar rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                    {% else %}
                      <div class="avatar rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <span class="text-white">{{ user.name|first|upper }}{{ user.prenom ? user.prenom|first|upper : '' }}</span>
                      </div>
                    {% endif %}
                    
                    <span class="position-absolute bg-{{ user.isOnline == 1 ? 'success' : 'secondary' }} border border-white rounded-circle"
                          style="width: 12px; height: 12px; bottom: 0; right: 0;"
                          title="{{ user.isOnline == 1 ? 'En ligne' : 'Hors ligne' }}">
                    </span>
                  </div>
                  
                  <div>
                    <p class="fw-bold mb-0 user-name">{{ user.prenom }} {{ user.name }}</p>
                    <small class="text-muted">
                      <i class="fas fa-clock me-1"></i> 
                      {% if user.lastActivity %}
                        Dernière activité: {{ user.lastActivity|date('d/m/Y H:i') }}
                      {% else %}
                        Jamais connecté
                      {% endif %}
                    </small>
                  </div>
                </div>
              </td>
              <td>
                <p class="mb-0">{{ user.email }}</p>
              </td>
              <td>
                <span class="badge bg-{% if user.roleUser == 'Admin' %}primary{% elseif user.roleUser == 'Voyageurs' %}info{% else %}success{% endif %}">
                  <i class="fas fa-{% if user.roleUser == 'Admin' %}user-shield{% elseif user.roleUser == 'Voyageurs' %}plane{% else %}building{% endif %} me-1"></i>
                  {{ user.roleUser }}
                </span>
              </td>
              <td>
                <p class="mb-0">{{ user.dateNaiss|date('d/m/Y') }}</p>
              </td>
              <td>
                <span class="badge bg-{% if user.deleteFlag == 1 %}danger{% elseif user.statut == 'actif' %}success{% else %}warning{% endif %}">
                  {{ user.deleteFlag == 1 ? 'Supprimé' : (user.statut == 'actif' ? 'Actif' : 'Inactif') }}
                </span>
              </td>
              <td class="text-center">
                <div class="btn-group">
                  <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editUserModal{{user.idU}}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete({{user.idU}})">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center py-4">
                <div class="alert alert-info mb-0">
                  <i class="fas fa-info-circle me-2"></i> Aucun utilisateur trouvé.
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Pagination -->
    <div class="card-footer d-flex justify-content-between align-items-center bg-light">
      <div class="pagination-info">
        Affichage de {{ users|length }} utilisateur(s)
      </div>
      <nav aria-label="Navigation des pages">
        <ul class="pagination mb-0">
          {% if currentPage > 1 %}
            <li class="page-item">
              <a class="page-link" href="{{ path('user_page', {'page': currentPage - 1}) }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% endif %}
          
          {% for i in 1..totalPages %}
            <li class="page-item {% if i == currentPage %}active{% endif %}">
              <a class="page-link" href="{{ path('user_page', {'page': i}) }}">{{ i }}</a>
            </li>
          {% endfor %}
          
          {% if currentPage < totalPages %}
            <li class="page-item">
              <a class="page-link" href="{{ path('user_page', {'page': currentPage + 1}) }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Hidden form for export to Excel -->
<form id="excelExportForm" action="{{ path('admin_users_export_excel') }}" method="post" class="d-none">
  <input type="hidden" id="excelRoleFilterValue" name="role" value="">
  <input type="hidden" id="excelStatusFilterValue" name="status" value="">
  <input type="hidden" id="excelSearchFilterValue" name="search" value="">
</form>

<!-- Hidden form for export to PDF -->
<form id="pdfExportForm" action="{{ path('admin_users_export_pdf') }}" method="post" class="d-none">
  <input type="hidden" id="roleFilterValue" name="role" value="">
  <input type="hidden" id="statusFilterValue" name="status" value="">
  <input type="hidden" id="searchFilterValue" name="search" value="">
</form>

<!-- Edit User Modals -->
{% for user in users %}
<div class="modal fade" id="editUserModal{{user.idU}}" tabindex="-1" aria-labelledby="editUserModal{{user.idU}}Label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModal{{user.idU}}Label">Modifier l'utilisateur</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm{{user.idU}}" action="{{ path('admin_user_edit', {'id_U': user.idU}) }}" method="post" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="name{{user.idU}}" class="form-label">Nom</label>
              <input type="text" class="form-control" id="name{{user.idU}}" name="name" value="{{ user.name }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="prenom{{user.idU}}" class="form-label">Prénom</label>
              <input type="text" class="form-control" id="prenom{{user.idU}}" name="prenom" value="{{ user.prenom }}" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="email{{user.idU}}" class="form-label">Email</label>
            <input type="email" class="form-control" id="email{{user.idU}}" name="email" value="{{ user.email }}" required>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="role{{user.idU}}" class="form-label">Rôle</label>
              <select class="form-select" id="role{{user.idU}}" name="role">
                <option value="Admin" {% if user.roleUser == 'Admin' %}selected{% endif %}>Admin</option>
                <option value="Voyageurs" {% if user.roleUser == 'Voyageurs' %}selected{% endif %}>Voyageurs</option>
                <option value="Entreprise" {% if user.roleUser == 'Entreprise' %}selected{% endif %}>Entreprise</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="status{{user.idU}}" class="form-label">Statut</label>
              <select class="form-select" id="status{{user.idU}}" name="status">
                <option value="actif" {% if user.statut == 'actif' %}selected{% endif %}>Actif</option>
                <option value="inactif" {% if user.statut == 'inactif' %}selected{% endif %}>Inactif</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="window.submitEditForm({{user.idU}})">Enregistrer</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %} 